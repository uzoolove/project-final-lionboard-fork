# 11장 API 사용 가이드

## 목차
- [1. 오픈마켓 API 서버](#1-오픈마켓-api-서버)
- [2. DB 초기화](#2-db-초기화)
- [3. API 서버 테스트](#3-api-서버-테스트)
- [4. 팀 프로젝트에 적용](#4-팀-프로젝트에-적용)
- [5. DB 확인](#5-db-확인)

# 1 오픈마켓 API 서버

- 제공되는 API 서버를 사용해서 FrontEnd를 완성하면 됩니다.
- API 서버의 주제는 오픈마켓이며 회원 관리, 상품 관리, 구매 관리, 후기 관리 등의 기능이 제공됩니다.
- API 서버는 대부분의 오픈 마켓에 적합하도록 범용적으로 제작되어 있어서 여러분이 구현하고 싶은 기능이 일부 제공되지 않을 수 있습니다.
- API에서 제공되지 않는 기능은 추가가 가능한지 문의해 주세요.

## 1.1 API 서버 구현 기술

- Application Server: Node.js + Express
- Database: MongoDB

## 1.2 URL
- API 호출 URL: `https://fesp-api.koyeb.app/market`
- API 변경 사항 확인: https://fesp-api.koyeb.app/market
- API 문서: https://fesp-api.koyeb.app/market/apidocs

# 2 DB 초기화

- API 서버가 사용하는 DB에 데이터 일부를 미리 추가해 두어야 API를 원활히 사용할 수 있으므로 이를 위해 초기화 스크립트를 실행

## 2.1 DB 초기화 파일 다운로드(오픈마켓)

- 프로젝트 루트 폴더에서 실행하면 api/dbinit 폴더에 DB 초기화 파일이 다운로드 됨
- 이전에 다운로드한 파일을 덮어씌우려면 --force 옵션 추가

### 초기화 파일 샘플
```sh
npx degit https://github.com/FEBC-API/APIServer/api/dbinit/openmarket api/dbinit/sample
```

### 팀에서 관리할 초기화 파일
```sh
npx degit https://github.com/FEBC-API/APIServer/api/dbinit/team api/dbinit/team
```

## 2.2 DB 초기화 파일 작성
- api/dbinit/team 폴더의 uploadFiles, data.json 파일 작성

### api/dbinit/sample 폴더 참조
- uploadFiles 폴더: DB 초기화 시 업로드할 파일
- data.json: DB 초기화 시 사용할 기본 데이터

# 3 API 서버 테스트
* API 테스트 파일을 저장할 폴더 생성
* 프로젝트 루트에서 실행

  ```sh
  mkdir api/bruno
  ```

## 3.1 Bruno란?

- Bruno는 Postman과 유사한 UI를 제공하는 오픈소스 API 테스트 도구
- Postman과 차별점
  - API 요청 정보를 클라우드에 저장하지 않고 로컬의 파일 시스템에 저장
  - Git과 같은 버전 관리 도구와 쉽게 통합되어 협업이 가능

### 3.2 Bruno 설치

- https://www.usebruno.com/downloads 접속 후 본인의 OS에 맞는 버전 다운로드 후 기본 설정 그대로 설치
  - 최신버전 3.0.2에서는 파일 업로드시 여러개를 선택 못하므로 2.15.1로 선택해서 다운로드
  - 다운로드 페이지의 Binaries 옆에 셀렉트 박스를 눌러서 버전을 선택할 수 있음

### 3.3 Collection 생성
- 좌측 상단의 bruno 로고(🐶) 클릭
- COLLECTIONS > Create Collection
  - Name: `test-final`
  - Location: lionboard/api/bruno
  - Folder Name: test-final
  - Create

### 3.4 환경 변수 추가

- test-final Collection 선택
  - 팝업창이 뜨면 Safe Mode 선택 후 Save
- Bruno 우측 상단의 No Environment > Create
  - Environment Name: prod
    - Create
  - Add variable
    - Name: `url`
    - Value: `https://fesp-api.koyeb.app/market`
  - Add variable
    - Name: `client-id`
    - Value: `openmarket`
  - Save

### 3.5 게시물 목록 조회 테스트

- test-final 컬렉션에 마우스 올린 후 더보기(...) > New Request
  - Type: HTTP
  - Request Name: `게시물 목록 조회`
  - URL: GET, `{{url}}/posts`
  - Create
- Params > Add Param
  - Name: `type`
  - Value: `info`
- URL 우측에 있는 **화살표(->)** 클릭해서 요청 전송
- 결과 확인

  ```json
  {
    "ok": 0,
    "message": "client-id 헤더가 없습니다."
  }
  ```

### 3.6 헤더에 client-id 추가

- 매 요청시 헤더값으로 client-id를 자동으로 보내기 위한 설정

- test-final 컬렉션에 마우스 올린 후 더보기(...) > Settings > Headers > Add Header
  - Name: `client-id`
  - Value: `{{client-id}}`
  - Save

- [게시물 목록 조회] 테스트

### 3.7 게시물 북마크 추가 테스트

- test-final 컬렉션에 마우스 올린 후 더보기(...) > New Request
  - Type: HTTP
  - Request Name: `게시물 북마크 추가`
  - URL: POST, `{{url}}/bookmarks/post`
  - Create

- Body > No Body 선택 후 JSON으로 수정 후 입력

  ```json
  {
    "target_id": 3,
    "memo": "게시판 사용법 북마크"
  }
  ```

- URL 우측에 있는 **화살표(->)** 클릭해서 요청 전송

- 에러 확인

  - 로그인 후에 사용할 수 있는 API 이므로 로그인이 선행되어야 함.

  ```json
  {
    "ok": 0,
    "message": "authorization 헤더가 없습니다.",
    "errorName": "EmptyAuthorization"
  }
  ```

### 3.8 로그인 테스트

- test-final 컬렉션에 마우스 올린 후 더보기(...) > New Request
  - Type: HTTP
  - Request Name: `로그인`
  - URL: POST, `{{url}}/users/login`
  - Create

- Body > No Body 선택 후 JSON으로 수정 후 입력

  ```json
  {
    "email": "u1@market.com",
    "password": "11111111"
  }
  ```

- URL 우측에 있는 **화살표(->)** 클릭해서 요청 전송

- Response 확인
  - 로그인 성공시 응답데이터에 JWT 토큰이 item.token.accessToken, item.token.refreshToken 속성으로 전달됨
  - 로그인이 필요한 API 요청시 사용자 인증을 위해서 authorization 헤더에 accessToken을 전달해야 함

```json
{
  "ok": 1,
  "item": {
    "_id": 4,
    "createdAt": "2026.01.07 19:44:15",
    "updatedAt": "2026.01.07 19:44:15",
    "email": "u1@market.com",
    "name": "제이지",
    "phone": "01044445555",
    "address": "서울시 강남구 논현동 222",
    "type": "user",
    "loginType": "email",
    "image": "https://res.cloudinary.com/ddedslqvv/image/upload/v1762361890/openmarket/_zBwtmoZKpL.webp",
    "extra": {
      "birthday": "11-30",
      "membershipClass": "MC02",
      "address": [
        {
          "id": 1,
          "name": "회사",
          "value": "서울시 강동구 천호동 123"
        },
        {
          "id": 2,
          "name": "집",
          "value": "서울시 강동구 성내동 234"
        }
      ]
    },
    "notifications": [],
    "token": {
      "accessToken": "eyJhbGc...iqTWndo",
      "refreshToken": "eyJhbG....WheEps"
    }
  }
}
```

### 3.9 Collection에 로그인 스크립트 추가

#### 토큰값 저장
- 로그인 성공 후 받은 토큰값을 환경 변수에 저장

- [로그인] 요청의 Script 탭 선택
  - 다음 코드를 Post Response에 추가 후 저장

  ```js
  // 로그인 성공 후
  if(res.status === 200){
    bru.setEnvVar('accessToken', res.body.item.token.accessToken);
    bru.setEnvVar('refreshToken', res.body.item.token.refreshToken);
  }
  ```

- [로그인] 요청 후에 환경 변수값 accessToken, refreshToken이 생성되었는지 확인
  - Bruno 우측 상단의 prod > Configure 선택한 후 accessToken, refreshToken 변수 확인 후 닫기

#### 요청 헤더에 토큰 인증 정보 추가

- 환경 변수에 추가한 토큰을 요청 헤더에 자동으로 추가

- test-final 컬렉션에 마우스 올린 후 더보기(...) > Settings
  - Auth > No Auth 클릭해서 Bearer Token 선택
  - Token: `{{accessToken}}`
  - Save

### 3.10 게시물 북마크 추가 테스트

- [게시물 북마크 추가] > Auth > `No Auth`일 경우 `Inherit` 변경 후 요청 전송
  - 결과 확인
  ```json
  {
    "ok": 1,
    "item": {
      "type": "post",
      "user_id": 4,
      "target_id": 3,
      "user": {
        "_id": 4,
        "name": "제이지",
        "email": "u1@market.com",
        "image": "https://res.cloudinary.com/ddedslqvv/image/upload/v1762361890/openmarket/_zBwtmoZKpL.webp"
      },
      "memo": "게시판 사용법 북마크",
      "_id": 6,
      "createdAt": "2026.01.13 18:09:22"
    }
  }
  ```

## 3.11 샘플 Bruno 파일 다운로드

- 프로젝트 루트 폴더에서 실행하면 api/bruno 폴더에 bruno API 테스트 파일이 다운로드 됨
- 이전에 다운로드한 파일을 덮어씌우려면 --force 옵션 추가

  ```sh
  npx degit https://github.com/FEBC-API/APIServer/api/bruno/openmarket api/bruno/sample
  npx degit https://github.com/FEBC-API/APIServer/api/bruno/team api/bruno/team
  ```

### 3.11.1 api/bruno/sample

- 모든 API를 테스트 할 수 있는 파일
- 수정은 하지 말고 테스트 용으로만 사용

### 3.11.2 api/bruno/team

- 각 팀별 API 테스트 파일
- 각 기능 담당자가 작성 후 푸시해서 팀 공유

### 3.11.3 테스트

- Bruno > Collection > Open Collection으로 `sample`, `team` 컬렉션 추가한 후 테스트

## 4. 팀 프로젝트에 적용
- 디스코드 팀 채널에서 팀원중 한명이 화면 공유해서 진행

### 4.1 팀 프로젝트 DB 초기화
- 팀 프로젝트 폴더에서 [2. DB 초기화](#2-db-초기화) 작업 수행
- api/dbinit/team 폴더의 파일을 팀에 맞게 수정 후 [DB 초기화 API](https://fesp-api.koyeb.app/market/apidocs/#/시스템/post_db_init) 작업 실행
  - Bruno의 `sample` 컬렉션의 `00-DB초기화` 폴더를 참고해서 `team` 컬렉션의 `00-DB초기화` 작업 수행

### 4.2 팀 프로젝트 API 서버 테스트
- 팀 프로젝트 폴더에서 [3.11 샘플 Bruno 파일 다운로드](#311-샘플-bruno-파일-다운로드) 작업 수행
- Bruon의 team 컬렉션 선택 후 환경변수 prod의 client-id는 각 팀에게 부여된 값 `febc15-final팀번호-ecad`으로 수정
  - 5팀 예시, `febc15-final05-ecad`

#### 팀 레포지토리에 반영
- 수행한 작업에 대한 PR 생성 후 push

#### 담당 기능에 대한 API 테스트
- 팀원은 pull 받은 후 Bruno > Collection > Open Collection으로 team 컬렉션 추가 후 담당 기능에 대한 API 테스트 추가

## 5. DB 확인
- API 서버가 MongoDB로 구축되어 있으므로 MongoDB용 GUI인 Compass를 사용하여 데이터베이스를 탐색하고 조작할 수 있음.

### 5.1 Mongodb Compass 설치
- https://www.mongodb.com/try/download/compass 에서 각자 플랫폼에 맞는 설치파일 다운로드 후 기본 옵션으로 설치

### 5.2 데이터베이스 접속
- MongoDB Compass 실행 후 `+` 버튼(Add new connection) 선택

<img src="images/11-01.png" width="640">

- 접속 정보 추가
  - URI: `mongodb+srv://팀client-id:팀비밀번호@openmarket.ehetjb8.mongodb.net/`
    - 팀client-id는 팀별로 부여받은 client-id 입력
    - 팀비밀번호는 client-id 뒤에 `__` 추가
    - 5팀 예시, `mongodb+srv://febc15-final05-ecad:febc15-final05-ecad__@openmarket.ehetjb8.mongodb.net/`
  - Name: final팀번호-프로젝트
    - 5팀 예시, `final05-lionboard`
  - Save & Connect

<img src="images/11-02.png" width="640">

#### 접속 결과 확인
- 접속한 데이터베이스의 file_uploads 컬렉션을 선택해서 업로드한 파일의 수가 맞는지 확인
  - 기본으로 제공된 api/dainit/team/uploadFiles에는 3개의 파일이 있으며 초기 파일만 업로드 했을 경우 3개가 있어야 함.

<img src="images/11-03.png" width="640">